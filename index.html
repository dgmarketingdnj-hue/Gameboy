<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Earn Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/sdk@1.1.3/tonconnect-sdk.min.js"></script> <!-- TON Connect -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- Monetag SDK -->
    <script src="//libtl.com/sdk.js" data-zone="10362739" data-sdk="show_10362739" async></script>
    <!-- ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ + ‡¶®‡¶§‡ßÅ‡¶® -->
    <style>
        /* ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ + ‡¶®‡¶§‡ßÅ‡¶® */
        #leaderboard-modal, #withdraw-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1001; color: white; padding: 20px; overflow-y: auto; }
        #leaderboard-list { list-style: none; padding: 0; }
        #leaderboard-list li { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        button { /* ‡¶Ü‡¶ó‡ßá‡¶∞ */ }
    </style>
</head>
<body>
    <!-- ‡¶Ü‡¶ó‡ßá‡¶∞ HTML + ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
    <button onclick="showLeaderboard()">üèÜ Leaderboard</button>
    <button onclick="showWithdraw()">üí∞ Withdraw to TON</button>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal">
        <h2>üèÜ Global Leaderboard</h2>
        <ul id="leaderboard-list"></ul>
        <button onclick="closeLeaderboard()">Close</button>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal">
        <h2>üí∞ Withdraw Points to TON</h2>
        <p>Connect wallet to claim!</p>
        <button id="connect-wallet-btn" onclick="connectWallet()">Connect TON Wallet</button>
        <input id="withdraw-amount" type="number" placeholder="Points (min 1000)" />
        <button id="withdraw-btn" onclick="withdraw()" disabled>Withdraw</button>
        <button onclick="closeWithdraw()">Close</button>
    </div>

    <script>
        // Firebase Config (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ project ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            // ... full config
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // TON Connect
        const connector = new TON_CONNECT_SDK.TonConnect({
            manifestUrl: 'https://your-site.com/tonconnect-manifest.json' // manifest ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® (GitHub demo ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®)
        });
        let walletAddress = null;

        // User ID from Telegram
        const userId = Telegram.WebApp.initDataUnsafe.user?.id;
        const username = Telegram.WebApp.initDataUnsafe.user?.first_name || 'Player';

        // Save Points to Firebase (tap-‡¶è ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®)
        async function savePoints() {
            await db.collection('leaderboard').doc(userId).set({
                userId, username, points,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Leaderboard Load
        async function showLeaderboard() {
            const snapshot = await db.collection('leaderboard').orderBy('points', 'desc').limit(50).get();
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            snapshot.forEach((doc, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>#${index+1} ${doc.data().username}</span><span>${doc.data().points.toLocaleString()}</span>`;
                list.appendChild(li);
            });
            document.getElementById('leaderboard-modal').style.display = 'block';
        }
        function closeLeaderboard() { document.getElementById('leaderboard-modal').style.display = 'none'; }

        // TON Wallet Connect
        async function connectWallet() {
            try {
                await connector.connectWallet();
                walletAddress = connector.connectedWallet?.account?.address;
                document.getElementById('connect-wallet-btn').innerText = `Connected: ${walletAddress.slice(0,6)}...`;
                document.getElementById('withdraw-btn').disabled = false;
            } catch(e) { alert('Connect failed!'); }
        }

        // Withdraw
        async function withdraw() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (amount < 1000 || points < amount) return alert('Min 1000 points!');
            
            // Backend-‡¶è verify + send Jetton (Node.js endpoint ‡¶¨‡¶æ‡¶®‡¶æ‡¶®)
            const tx = {
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [{
                    address: walletAddress,
                    amount: (amount / 1000 * 1e9).toString(), // 1 point = 0.001 TON example
                    payload: 'Withdraw'
                }]
            };
            await connector.sendTransaction(tx);
            points -= amount;
            updatePoints();
            savePoints();
            alert('Withdrawn! Check wallet.');
        }
        function showWithdraw() { document.getElementById('withdraw-modal').style.display = 'block'; }
        function closeWithdraw() { document.getElementById('withdraw-modal').style.display = 'none'; }

        // Tap-‡¶è savePoints() ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (updatePoints-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá)
        // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶ï‡ßã‡¶° ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®...

        updatePoints();
    </script>
</body>
</html>
